<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¹³å°ç¿»è­¯ App</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ PDF.js ç”¨æ–¼è§£æ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* é è¨­æ·ºç°èƒŒæ™¯ */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
            pointer-events: none;
        }

        /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        #camera-feed {
            width: 100%;
            height: auto;
            max-height: 80vh;
            border-radius: 0.75rem;
            object-fit: cover;
        }
        #photo-canvas {
            display: none;
        }
        
        #image-preview-container {
            transition: all 0.3s ease;
        }
        #image-preview-container.hidden {
            display: none;
        }

        /* --- è‡ªå®šç¾©æ²å‹•æ¢ (Scrollbar) --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3); 
        }
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 justify-center">

    <!-- é ‚éƒ¨åŠŸèƒ½åˆ— -->
    <header class="w-full max-w-6xl flex justify-between items-center mb-4 mt-2 px-2">
        <div class="flex items-center gap-2">
             <!-- å·¦å´ Logo å€åŸŸ (å¯é¸) -->
             <span class="text-xl font-bold text-gray-800/80 tracking-tight"></span>
        </div>
        
        <div class="flex gap-3">
            <input type="file" id="bg-upload" accept="image/*" class="hidden">
            <button id="change-bg-btn" class="flex items-center px-4 py-2 bg-white/80 hover:bg-white text-gray-700 font-medium rounded-full shadow-sm transition duration-200 backdrop-blur-sm border border-gray-200 text-sm">
                ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯
            </button>
            <button id="settings-btn" class="flex items-center p-2 bg-white/80 hover:bg-white text-gray-700 font-medium rounded-full shadow-sm transition duration-200 backdrop-blur-sm border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- ä¸»ä»‹é¢ -->
    <main id="main-content" class="w-full max-w-6xl flex flex-col lg:flex-row gap-6 mt-4">

        <!-- å·¦å´ï¼šç¿»è­¯å€ -->
        <div id="translator-card" class="lg:w-2/3 glass-panel rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-300 flex flex-col">
            
            <!-- èªè¨€é¸æ“‡ -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4 flex-shrink-0">
                <div class="flex-1 w-full sm:w-auto group">
                    <div class="relative">
                        <select id="source-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm">
                            <option value="auto" selected>âœ¨ è‡ªå‹•åµæ¸¬èªè¨€</option>
                            <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                            <option value="en">è‹±æ–‡</option>
                            <option value="ja">æ—¥æ–‡</option>
                            <option value="ko">éŸ“æ–‡</option>
                            <option value="es">è¥¿ç­ç‰™æ–‡</option>
                            <option value="fr">æ³•æ–‡</option>
                            <option value="de">å¾·æ–‡</option>
                            <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                            <option value="vi">è¶Šå—æ–‡</option>
                            <option value="th">æ³°æ–‡</option>
                            <option value="id">å°å°¼æ–‡</option>
                        </select>
                    </div>
                </div>

                <button id="swap-btn" class="p-3 bg-white/80 rounded-full hover:bg-blue-50 text-blue-600 transition duration-150 ease-in-out shadow-sm border border-gray-100 sm:mt-6 group backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m2.25-4.5L21 7.5m0 0L16.5 3M21 7.5H7.5" />
                    </svg>
                </button>
                
                <div class="flex-1 w-full sm:w-auto group">
                    <div class="relative">
                        <select id="target-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm">
                            <option value="en" selected>è‹±æ–‡</option>
                            <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                            <option value="ja">æ—¥æ–‡</option>
                            <option value="ko">éŸ“æ–‡</option>
                            <option value="es">è¥¿ç­ç‰™æ–‡</option>
                            <option value="fr">æ³•æ–‡</option>
                            <option value="de">å¾·æ–‡</option>
                            <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                            <option value="vi">è¶Šå—æ–‡</option>
                            <option value="th">æ³°æ–‡</option>
                            <option value="id">å°å°¼æ–‡</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- è¼¸å…¥èˆ‡è¼¸å‡ºå€ (Grid) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow h-[55vh] min-h-[450px]">
                
                <!-- å·¦æ¬„ï¼šè¼¸å…¥å€ -->
                <div class="flex flex-col h-full relative">
                    <!-- åœ–ç‰‡é è¦½å€ -->
                    <div id="image-preview-container" class="hidden mb-2 relative bg-gray-100/80 rounded-lg overflow-hidden border border-dashed border-gray-400 backdrop-blur-sm flex-shrink-0 h-32">
                        <img id="image-preview" src="" alt="é è¦½" class="w-full h-full object-contain bg-transparent">
                        <button id="clear-image-btn" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <textarea id="source-text" 
                        class="w-full flex-grow p-4 bg-white/60 border border-gray-200 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none text-gray-800 placeholder-gray-500 backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed" 
                        placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–ç›´æ¥è²¼ä¸Šæˆªåœ– (Ctrl+V) è‡ªå‹•ç¿»è­¯..."></textarea>
                    
                    <!-- å·¦å´æŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="mt-4 flex gap-3 flex-shrink-0">
                        <button id="scan-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-emerald-500/90 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                            </svg>
                            ç›¸æ©Ÿ
                        </button>
                        
                        <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
                        <button id="pdf-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-red-500/90 hover:bg-red-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            ä¸Šå‚³ PDF
                        </button>
                    </div>
                </div>
                
                <!-- å³æ¬„ï¼šçµæœå€ -->
                <div class="flex flex-col h-full relative">
                    <textarea id="target-text" 
                        class="w-full flex-grow p-4 bg-blue-50/60 border border-blue-100 rounded-xl text-gray-800 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed" 
                        readonly
                        placeholder="è¼¸å…¥æ–‡å­—ã€è²¼ä¸Šåœ–ç‰‡æˆ–ä¸Šå‚³ PDF å¾Œï¼Œå°‡è‡ªå‹•é–‹å§‹ç¿»è­¯..."></textarea>

                    <!-- å³å´æŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="mt-4 flex gap-3 flex-shrink-0">
                        <button id="copy-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-500/90 hover:bg-blue-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                            è¤‡è£½
                        </button>
                        
                        <button id="speak-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-indigo-500/90 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            æœ—è®€
                        </button>
                    </div>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯å’Œ API ç‹€æ…‹ -->
            <div id="status-message" class="mt-4 text-center text-red-500 font-medium hidden bg-red-50/80 p-2 rounded-lg"></div>
        </div>

        <!-- å³å´ï¼šæ­·å²ç´€éŒ„å´é‚Šæ¬„ (å›ºå®šé«˜åº¦ + æ²å‹•) -->
        <div id="history-sidebar" class="lg:w-1/3 glass-panel rounded-2xl shadow-xl p-6 transition-all duration-300 flex flex-col h-[65vh] min-h-[500px]">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200/50 pb-3 flex items-center flex-shrink-0">
                ç¿»è­¯æ­·å²ç´€éŒ„
            </h2>
            <div id="history-list" class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-grow">
                <!-- History items will be inserted here -->
                <div id="history-placeholder" class="text-gray-500 text-sm py-4 text-center">
                    <div class="animate-pulse flex space-x-4 justify-center mb-2">
                        <div class="h-2 bg-gray-300 rounded w-1/3"></div>
                    </div>
                    <p>æ­£åœ¨é€£ç·šè³‡æ–™åº«...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 mb-4 flex flex-col items-center">
        <p class="text-gray-500 text-sm bg-white/40 px-3 py-1 rounded-md backdrop-blur-sm">
            ç¿»è­¯ç”± Gemini 2.5 Flash æä¾›æ”¯æ´
        </p>
    </footer>

    <!-- ç›¸æ©Ÿæƒæå½ˆå‡ºè¦–çª— -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                ç›¸æ©Ÿæƒæ
            </h2>
            <div class="relative flex justify-center items-center bg-black rounded-xl overflow-hidden shadow-inner aspect-[3/4] md:aspect-video">
                <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="photo-canvas"></canvas>
            </div>
            
            <div id="camera-message" class="text-center text-sm text-red-500 mt-2 hidden"></div>

            <div class="flex justify-between mt-6 space-x-3">
                <button id="close-modal-btn" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button id="capture-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition disabled:opacity-50">
                    æˆªåœ–ä¸¦ç¿»è­¯
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå½ˆå‡ºè¦–çª— -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center border-b pb-2">
                âš™ï¸ æ‡‰ç”¨ç¨‹å¼è¨­å®š
            </h2>
            <p class="text-sm text-gray-600 mb-4">è‹¥è¦å°‡æ­¤ App éƒ¨ç½²åˆ°ç¶²ç«™ä¸Šä½¿ç”¨ï¼Œè«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ API é‡‘é‘°ã€‚é€™äº›è³‡æ–™åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <input type="password" id="setting-api-key" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Šæ‚¨çš„ Google AI Studio API Key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase Config (JSON)</label>
                    <textarea id="setting-firebase-config" rows="5" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-xs font-mono" placeholder='{"apiKey": "...", "authDomain": "...", ...}'></textarea>
                    <p class="text-xs text-gray-500 mt-1">è‹¥ä¸éœ€è¦æ­·å²ç´€éŒ„åŠŸèƒ½ï¼Œæ­¤æ¬„ä½å¯ç•™ç©ºã€‚</p>
                </div>
            </div>

            <div class="flex justify-end mt-6 space-x-3">
                <button id="close-settings-btn" class="px-4 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">å„²å­˜ä¸¦é‡æ–°è¼‰å…¥</button>
            </div>
        </div>
    </div>


    <script type="module">
        // -------------------------
        // 1. Firebase å’Œ API åˆå§‹åŒ–
        // -------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, onSnapshot, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let auth, db, userId = null;
        let isAuthReady = false;
        let cameraStream = null;
        
        let localApiKey = localStorage.getItem('gemini_api_key') || "";
        let localFirebaseConfigStr = localStorage.getItem('firebase_config_str') || "";
        
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const envInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = {};
        let apiKey = localApiKey; 
        
        if (localFirebaseConfigStr) {
            try { firebaseConfig = JSON.parse(localFirebaseConfigStr); } catch (e) { console.error("Config Error", e); }
        } else {
            firebaseConfig = envFirebaseConfig;
        }

        const initFirebaseSystem = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("UserID:", userId);
                            isAuthReady = true;
                            loadTranslationHistory();
                        }
                    });

                    if (envInitialAuthToken && !localFirebaseConfigStr) {
                        await signInWithCustomToken(auth, envInitialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    document.getElementById('history-placeholder').textContent = "æ­·å²ç´€éŒ„æœå‹™ç„¡æ³•é€£ç·š";
                }
            } else {
                console.warn("No Firebase Config");
                document.getElementById('history-placeholder').textContent = "æœªè¨­å®šè³‡æ–™åº«";
            }
        };

        initFirebaseSystem();


        // -------------------------
        // 2. è¨­å®šèˆ‡èƒŒæ™¯
        // -------------------------
        const bgUploadInput = document.getElementById('bg-upload');
        const changeBgBtn = document.getElementById('change-bg-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingApiKeyInput = document.getElementById('setting-api-key');
        const settingFirebaseConfigInput = document.getElementById('setting-firebase-config');

        function loadSavedBackground() {
            const savedBg = localStorage.getItem('translatorAppBg');
            if (savedBg) {
                document.body.style.backgroundImage = `url(${savedBg})`;
            }
        }

        changeBgBtn.addEventListener('click', () => bgUploadInput.click());

        bgUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const bgUrl = event.target.result;
                    document.body.style.backgroundImage = `url(${bgUrl})`;
                    try { localStorage.setItem('translatorAppBg', bgUrl); } catch (err) {}
                };
                reader.readAsDataURL(file);
            }
        });

        settingsBtn.addEventListener('click', () => {
            settingApiKeyInput.value = localStorage.getItem('gemini_api_key') || "";
            settingFirebaseConfigInput.value = localStorage.getItem('firebase_config_str') || "";
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        saveSettingsBtn.addEventListener('click', () => {
            const newApiKey = settingApiKeyInput.value.trim();
            const newFirebaseConfig = settingFirebaseConfigInput.value.trim();
            if (newApiKey) localStorage.setItem('gemini_api_key', newApiKey);
            else localStorage.removeItem('gemini_api_key');
            if (newFirebaseConfig) localStorage.setItem('firebase_config_str', newFirebaseConfig);
            else localStorage.removeItem('firebase_config_str');
            alert('è¨­å®šå·²å„²å­˜ï¼');
            location.reload();
        });


        // -------------------------
        // 3. ç¿»è­¯èˆ‡ä»‹é¢é‚è¼¯
        // -------------------------

        const sourceTextEl = document.getElementById('source-text');
        const targetTextEl = document.getElementById('target-text');
        const sourceLangEl = document.getElementById('source-lang');
        const targetLangEl = document.getElementById('target-lang');
        const swapBtn = document.getElementById('swap-btn');
        const scanBtn = document.getElementById('scan-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const copyBtn = document.getElementById('copy-btn'); // New
        const speakBtn = document.getElementById('speak-btn'); // New
        const pdfUploadInput = document.getElementById('pdf-upload');
        const statusMessageEl = document.getElementById('status-message');
        const historyListEl = document.getElementById('history-list');
        const historyPlaceholderEl = document.getElementById('history-placeholder');
        
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const clearImageBtn = document.getElementById('clear-image-btn');
        let currentBase64Image = null;
        let isPdfMode = false;

        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cameraMessage = document.getElementById('camera-message');

        let debounceTimer;

        async function fetchWithExponentialBackoff(apiCall, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function saveTranslationToHistory(sourceText, targetText, sourceLang, targetLang) {
            if (!isAuthReady || !userId || !db) return;
            const currentAppId = envAppId || 'my-translator-app';
            try {
                await addDoc(collection(db, 'artifacts', currentAppId, 'users', userId, 'translationHistory'), {
                    sourceText: sourceText,
                    targetText: targetText,
                    sourceLang: sourceLang,
                    targetLang: targetLang,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("å„²å­˜å¤±æ•—:", error);
            }
        }

        async function translateText(base64Image = null) {
            if (!apiKey) {
                targetTextEl.value = 'âš ï¸ æœªè¨­å®š API Keyã€‚è«‹é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ è¨­å®šã€æŒ‰éˆ•ï¼Œè¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚';
                return;
            }

            const inputText = sourceTextEl.value.trim();
            const sourceLang = sourceLangEl.value;
            const targetLang = targetLangEl.value;

            if (!inputText && !base64Image) return;

            statusMessageEl.classList.add('hidden');
            targetTextEl.value = 'âœ¨ AI æ­£åœ¨æ€è€ƒä¸¦ç¿»è­¯ä¸­...';

            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            let systemPrompt = "You are a highly accurate and professional language translator. Your task is to provide a precise translation into the target language. Crucially, ensure that the translated text adheres to the strict grammatical rules, appropriate tense, and idiomatic correctness of the target language. Do not include any extra commentary, explanations, or formatting. Only return the translated text.";
            
            if (isPdfMode && !base64Image) {
                systemPrompt = "You are a bilingual document translator. Translate the given text into the target language. Crucially, output the result in a 'Bilingual Format': For each paragraph of the original text, display the ORIGINAL text first, followed immediately by its TRANSLATION. Separate the original and translation clearly (e.g., with a line break). Maintain the original paragraph structure.";
            }

            let textPrompt = "";
            if (sourceLang === 'auto') {
                textPrompt = `Translate the following text into ISO-639-1 code "${targetLang}". Automatically detect the source language. If input is an image, first perform OCR to extract the text, and then translate it. If input is text, translate directly. Return ONLY the translated text (or bilingual text if requested).`;
            } else {
                textPrompt = `Translate the following text from ISO-639-1 code "${sourceLang}" to ISO-639-1 code "${targetLang}". If input is an image, first perform OCR to extract the text, and then translate it. If input is text, translate directly. Return ONLY the translated text (or bilingual text if requested).`;
            }
            
            const contents = [];
            let sourceTextForHistory = inputText;

            if (base64Image) {
                sourceTextForHistory = `[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]`; 
                contents.push({
                    parts: [
                        { text: textPrompt },
                        { inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } }
                    ]
                });
            } else {
                contents.push({
                    parts: [
                        { text: `${textPrompt} The text to translate is: \n\n"${inputText}"` }
                    ]
                });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            
            let translatedText = null;

            try {
                const apiCall = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
                    }
                    return response.json();
                };

                const result = await fetchWithExponentialBackoff(apiCall);
                translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (translatedText) {
                    targetTextEl.value = translatedText.trim();
                    saveTranslationToHistory(sourceTextForHistory, translatedText.trim(), sourceLang, targetLang);
                } else {
                    targetTextEl.value = 'ç¿»è­¯å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }

            } catch (error) {
                console.error("éŒ¯èª¤:", error);
                statusMessageEl.textContent = `éŒ¯èª¤: ${error.message}`;
                statusMessageEl.classList.remove('hidden');
                targetTextEl.value = 'é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key æˆ–ç¶²è·¯é€£ç·šã€‚';
            }
        }

        // --- Copy & Speak Logic (New) ---
        copyBtn.addEventListener('click', async () => {
            const textToCopy = targetTextEl.value; // Changed to value for textarea
            if (!textToCopy || textToCopy.includes('è¼¸å…¥æ–‡å­—') || textToCopy.includes('AI æ­£åœ¨æ€è€ƒ')) return;
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    targetTextEl.select();
                    document.execCommand('copy');
                }
                const originalText = copyBtn.innerText;
                copyBtn.innerText = `âœ… å·²è¤‡è£½`;
                setTimeout(() => copyBtn.innerText = originalText, 2000);
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—', err);
            }
        });

        speakBtn.addEventListener('click', () => {
            const textToSpeak = targetTextEl.value; // Changed to value for textarea
            if (!textToSpeak || textToSpeak.includes('è¼¸å…¥æ–‡å­—') || textToSpeak.includes('AI æ­£åœ¨æ€è€ƒ')) return;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            const targetLang = targetLangEl.value;
            utterance.lang = targetLang === 'zh-Hant' ? 'zh-TW' : targetLang;
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        });


        // --- PDF è™•ç† ---
        pdfBtn.addEventListener('click', () => pdfUploadInput.click());

        pdfUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') { alert('è«‹ä¸Šå‚³ PDF æª”æ¡ˆ'); return; }

            isPdfMode = true; 
            clearImagePreview();
            targetTextEl.value = 'ğŸ“„ æ­£åœ¨è§£æ PDF æ–‡ä»¶ï¼Œè«‹ç¨å€™...';
            sourceTextEl.value = 'æ­£åœ¨è®€å– PDF å…§å®¹...';
            sourceTextEl.disabled = true;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                if (!fullText.trim()) {
                    sourceTextEl.value = 'PDF è§£æå®Œæˆï¼Œä½†æœªç™¼ç¾å¯æå–çš„æ–‡å­—ã€‚\n\né€™å¯èƒ½æ˜¯ä¸€å€‹æƒæç‰ˆ PDF (åœ–ç‰‡æ ¼å¼)ã€‚è«‹ä½¿ç”¨ã€Œç›¸æ©Ÿã€åŠŸèƒ½ç¿»æ‹æˆ–å°‡é é¢æˆªåœ–è²¼ä¸Šä¾†é€²è¡Œç¿»è­¯ã€‚';
                    targetTextEl.value = 'ç„¡æ³•æå–æ–‡å­—ï¼Œå¯èƒ½æ˜¯åœ–ç‰‡å‹ PDFã€‚';
                } else {
                    sourceTextEl.value = fullText.trim();
                    translateText();
                }
            } catch (error) {
                console.error('PDF éŒ¯èª¤:', error);
                sourceTextEl.value = '';
                targetTextEl.value = 'PDF è§£æå¤±æ•—ã€‚';
            } finally {
                sourceTextEl.disabled = false;
                pdfUploadInput.value = '';
            }
        });

        // --- è‡ªå‹•ç¿»è­¯èˆ‡äº‹ä»¶ç›£è½ ---
        function debounceTranslate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (!currentBase64Image && sourceTextEl.value.trim()) {
                    translateText();
                }
            }, 1000); 
        }

        sourceTextEl.addEventListener('input', () => {
            if (currentBase64Image) clearImagePreview();
            
            if (sourceTextEl.value.trim() === '') {
                isPdfMode = false;
                targetTextEl.value = ''; // Clear result
                return;
            }
            debounceTranslate();
        });

        sourceTextEl.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        handleImageInput(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                    return;
                }
            }
        });

        function handleImageInput(base64) {
            currentBase64Image = base64;
            isPdfMode = false;
            imagePreview.src = base64;
            imagePreviewContainer.classList.remove('hidden');
            sourceTextEl.value = ''; 
            sourceTextEl.placeholder = "å·²åµæ¸¬åœ–ç‰‡æ¨¡å¼ï¼Œè¼¸å…¥æ–‡å­—å°‡åˆ‡æ›å›æ–‡å­—ç¿»è­¯...";
            translateText(base64);
        }

        function clearImagePreview() {
            currentBase64Image = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            sourceTextEl.placeholder = "è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–ç›´æ¥è²¼ä¸Šæˆªåœ– (Ctrl+V) è‡ªå‹•ç¿»è­¯...";
        }
        
        clearImageBtn.addEventListener('click', () => {
            clearImagePreview();
            targetTextEl.value = '';
        });

        // --- æ­·å²ç´€éŒ„èˆ‡å…¶ä»– ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function renderHistory(snapshot) {
            historyListEl.innerHTML = '';
            if (snapshot.empty) {
                historyListEl.innerHTML = '<div class="text-center text-gray-500 py-6 bg-white/50 rounded-lg">å°šç„¡ç´€éŒ„</div>';
                return;
            }
            const historyRecords = [];
            snapshot.forEach(doc => historyRecords.push(doc.data()));
            historyRecords.sort((a, b) => {
                if (!a.timestamp || !b.timestamp) return 0;
                try { return b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime(); } 
                catch (e) { return 0; }
            });
            historyRecords.forEach(data => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item bg-white/70 p-4 rounded-xl border border-gray-100 hover:bg-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md flex-shrink-0';
                historyItem.addEventListener('click', () => {
                    if (data.sourceText !== '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]') {
                        sourceTextEl.value = data.sourceText;
                        clearImagePreview();
                        isPdfMode = false;
                        translateText(); 
                    } else {
                        sourceTextEl.value = '';
                        targetTextEl.value = data.targetText;
                    }
                    sourceLangEl.value = data.sourceLang;
                    targetLangEl.value = data.targetLang;
                    document.getElementById('translator-card').scrollIntoView({ behavior: 'smooth' });
                });
                
                const displaySourceText = data.sourceText === '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]' 
                    ? '<span class="flex items-center text-emerald-600">åœ–ç‰‡ç¿»è­¯çµæœ</span>' 
                    : data.sourceText;
                const getLangName = (code) => {
                    const map = { 'auto': 'è‡ªå‹•', 'en': 'è‹±', 'zh-Hant': 'ä¸­', 'ja': 'æ—¥', 'ko': 'éŸ“', 'es': 'è¥¿', 'fr': 'æ³•' };
                    return map[code] || code.toUpperCase();
                };
                historyItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${getLangName(data.sourceLang)} â†’ ${getLangName(data.targetLang)}</span>
                        <span class="text-xs text-gray-400">${formatTimestamp(data.timestamp)}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-800 line-clamp-2 mb-1 break-all">${displaySourceText}</p>
                    <p class="text-xs text-gray-600 mt-1 line-clamp-2 pl-2 border-l-2 border-blue-300 break-all">${data.targetText}</p>
                `;
                historyListEl.appendChild(historyItem);
            });
        }
        
        function loadTranslationHistory() {
            if (!db || !userId) return;
            const currentAppId = envAppId || 'my-translator-app';
            const historyQuery = query(
                collection(db, 'artifacts', currentAppId, 'users', userId, 'translationHistory'),
                limit(50) 
            );
            onSnapshot(historyQuery, (snapshot) => renderHistory(snapshot), (error) => {
                console.error("è¼‰å…¥å¤±æ•—:", error);
            });
        }

        scanBtn.addEventListener('click', initCamera);
        captureBtn.addEventListener('click', captureImage);
        closeModalBtn.addEventListener('click', () => {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
        });
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) closeModalBtn.click();
        });

        swapBtn.addEventListener('click', () => {
            const tempSource = sourceLangEl.value;
            if (tempSource === 'auto') {
                sourceLangEl.value = targetLangEl.value;
                targetLangEl.value = 'zh-Hant'; 
            } else {
                sourceLangEl.value = targetLangEl.value;
                targetLangEl.value = tempSource;
            }
            if (sourceTextEl.value.trim()) translateText();
        });

        async function initCamera() {
            cameraMessage.classList.add('hidden');
            cameraModal.classList.add('flex');
            cameraModal.classList.remove('hidden');
            captureBtn.disabled = true;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
            } catch (err) {
                try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: true }); } 
                catch (err) { cameraMessage.textContent = 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ'; cameraMessage.classList.remove('hidden'); return; }
            }
            cameraFeed.srcObject = cameraStream;
            cameraFeed.onloadedmetadata = () => { cameraFeed.play(); captureBtn.disabled = false; };
        }

        function captureImage() {
            if (!cameraStream) return;
            const video = cameraFeed;
            const canvas = photoCanvas;
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL('image/png');
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
            handleImageInput(base64Image);
        }

        window.onload = () => {
            loadSavedBackground();
        }

    </script>
</body>

</html>

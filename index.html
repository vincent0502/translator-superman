<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¹³å°ç¿»è­¯ App</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ PDF.js ç”¨æ–¼è§£æ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* é è¨­æ·ºç°èƒŒæ™¯ */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
            pointer-events: none;
        }

        /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.85); /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* è‡ªå®šç¾©æ²å‹•æ¢ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        
        /* æ¡Œé¢ç‰ˆæ¨£å¼å¾®èª¿ */
        @media (min-width: 1024px) {
            #main-content {
                align-items: flex-start; /* æ”¹ç‚ºé ä¸Šå°é½Šï¼Œå› ç‚ºé«˜åº¦è®Šå°äº† */
            }
            .grid-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            /* ç§»é™¤åŸæœ¬å¼·åˆ¶çš„ min-height: 300pxï¼Œæ”¹ç”¨ min-height: auto æˆ–è¼ƒå°æ•¸å€¼ */
            #source-text, #target-text {
                min-height: 120px; /* è¨­å®šä¸€å€‹è¼ƒå°çš„æœ€å°é«˜åº¦ */
            }
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <!-- é ‚éƒ¨åŠŸèƒ½åˆ— -->
    <header class="w-full max-w-6xl flex justify-end items-center mb-2 mt-2 px-2 flex-shrink-0">
        <div class="flex gap-3">
            <!-- è¨­å®šé‡‘é‘°æŒ‰éˆ• (è‹¥å·²è¨­å®šæœƒè‡ªå‹•éš±è—) -->
            <button id="settings-btn" class="flex items-center px-4 py-2 bg-white/80 hover:bg-white text-gray-700 font-medium rounded-full shadow-sm transition duration-200 backdrop-blur-sm border border-gray-200 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
                </svg>
                è¨­å®šé‡‘é‘°
            </button>

            <input type="file" id="bg-upload" accept="image/*" class="hidden">
            <button id="change-bg-btn" class="flex items-center px-4 py-2 bg-white/80 hover:bg-white text-gray-700 font-medium rounded-full shadow-sm transition duration-200 backdrop-blur-sm border border-gray-200 text-sm">
                æ›´æ›èƒŒæ™¯
            </button>
        </div>
    </header>

    <!-- ä¸»ä»‹é¢ -->
    <main id="main-content" class="w-full max-w-6xl flex flex-col lg:flex-row gap-6 mt-2">

        <!-- å·¦å´ï¼šç¿»è­¯å€ -->
        <div id="translator-card" class="lg:w-2/3 glass-panel rounded-3xl shadow-xl p-6 transition-all duration-300 flex flex-col">
            
            <!-- èªè¨€é¸æ“‡ -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-3 sm:space-y-0 sm:space-x-4 flex-shrink-0">
                <div class="flex-1 w-full sm:w-auto relative group">
                    <select id="source-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm cursor-pointer text-base">
                        <option value="auto" selected>âœ¨ è‡ªå‹•åµæ¸¬èªè¨€</option>
                        <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                        <option value="en">è‹±æ–‡</option>
                        <option value="ja">æ—¥æ–‡</option>
                        <option value="ko">éŸ“æ–‡</option>
                        <option value="es">è¥¿ç­ç‰™æ–‡</option>
                        <option value="fr">æ³•æ–‡</option>
                        <option value="de">å¾·æ–‡</option>
                        <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                        <option value="vi">è¶Šå—æ–‡</option>
                        <option value="th">æ³°æ–‡</option>
                        <option value="id">å°å°¼æ–‡</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <button id="swap-btn" class="p-3 bg-white/80 rounded-full hover:bg-blue-50 text-blue-600 transition duration-150 ease-in-out shadow-sm border border-gray-100 sm:mt-6 group backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m2.25-4.5L21 7.5m0 0L16.5 3M21 7.5H7.5" />
                    </svg>
                </button>
                
                <div class="flex-1 w-full sm:w-auto relative group">
                    <select id="target-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm text-base">
                        <option value="en" selected>è‹±æ–‡</option>
                        <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                        <option value="ja">æ—¥æ–‡</option>
                        <option value="ko">éŸ“æ–‡</option>
                        <option value="es">è¥¿ç­ç‰™æ–‡</option>
                        <option value="fr">æ³•æ–‡</option>
                        <option value="de">å¾·æ–‡</option>
                        <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                        <option value="vi">è¶Šå—æ–‡</option>
                        <option value="th">æ³°æ–‡</option>
                        <option value="id">å°å°¼æ–‡</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            
            <!-- è¼¸å…¥èˆ‡è¼¸å‡ºå€ -->
            <div class="grid-container">
                
                <!-- å·¦æ¬„ï¼šè¼¸å…¥å€ -->
                <div class="input-group flex flex-col gap-3">
                    <!-- åœ–ç‰‡é è¦½å€ -->
                    <div id="image-preview-container" class="hidden relative bg-gray-100/80 rounded-xl overflow-hidden border border-dashed border-gray-400 backdrop-blur-sm flex-shrink-0 h-32">
                        <img id="image-preview" src="" alt="é è¦½" class="w-full h-full object-contain bg-transparent">
                        <button id="clear-image-btn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="textarea-container">
                        <!-- è¨­å®š rows="3" ä¸¦èª¿æ•´ padding èˆ‡ line-height -->
                        <textarea id="source-text" rows="3"
                            class="w-full p-4 bg-white/60 border border-gray-200 rounded-2xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none text-gray-800 placeholder-gray-500 backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed text-lg" 
                            placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–è²¼ä¸Šæˆªåœ–..."></textarea>
                    </div>
                    
                    <!-- æŒ‰éˆ•ç¾¤çµ„ (æ¸›å°‘ä¸Šæ–¹ margin) -->
                    <div class="flex gap-3 flex-shrink-0">
                        <button id="scan-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-emerald-500/90 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" />
                            </svg>
                            ç›¸æ©Ÿ
                        </button>
                        
                        <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
                        <button id="pdf-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-red-500/90 hover:bg-red-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25M15 12h3M7.5 16.5h4.5M7.5 12h7.5M8.25 3.75H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            ä¸Šå‚³ PDF
                        </button>
                    </div>
                </div>
                
                <!-- å³æ¬„ï¼šçµæœå€ -->
                <div class="output-group flex flex-col gap-3 mt-6 lg:mt-0">
                    <div class="textarea-container">
                        <!-- è¨­å®š rows="3" -->
                        <textarea id="target-text" rows="3"
                            class="w-full p-4 bg-blue-50/60 border border-blue-100 rounded-2xl text-gray-800 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed text-lg" 
                            readonly
                            placeholder="ç¿»è­¯çµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                    </div>

                    <!-- æŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="flex gap-3 flex-shrink-0">
                        <button id="copy-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-500/90 hover:bg-blue-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                            è¤‡è£½
                        </button>
                        
                        <button id="speak-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-indigo-500/90 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728m-9.18-12.728A13.5 13.5 0 002.25 12H4.5c0-.83.112-1.633.322-2.396C4.986 8.756 5.81 8.25 6.75 8.25h.488l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H6.75A2.25 2.25 0 014.5 15V9a2.25 2.25 0 012.25-2.25h3.636z" />
                            </svg>
                            æœ—è®€
                        </button>
                    </div>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯å’Œ API ç‹€æ…‹ -->
            <div id="status-message" class="mt-4 text-center text-red-500 font-medium hidden bg-red-50/80 p-2 rounded-lg flex-shrink-0"></div>
        </div>

        <!-- å³å´ï¼šæ­·å²ç´€éŒ„å´é‚Šæ¬„ -->
        <div id="history-sidebar" class="lg:w-1/3 glass-panel rounded-3xl shadow-xl p-6 transition-all duration-300 flex flex-col max-h-[600px] lg:max-h-none">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200/50 pb-3 flex items-center flex-shrink-0"> 
                ç¿»è­¯æ­·å²ç´€éŒ„
            </h2>
            <div id="history-list" class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-grow"> 
                <!-- History items will be inserted here -->
                <div id="history-placeholder" class="text-gray-500 text-sm py-4 text-center">
                    <div class="animate-pulse flex space-x-4 justify-center mb-2">
                        <div class="h-2 bg-gray-300 rounded w-1/3"></div>
                    </div>
                    <p>æ­£åœ¨é€£ç·šè³‡æ–™åº«...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 mb-4 flex flex-col items-center">
        <p class="text-gray-500 text-sm bg-white/40 px-3 py-1 rounded-md backdrop-blur-sm">
            ç¿»è­¯ç”± Gemini 2.5 Flash æä¾›æ”¯æ´
        </p>
    </footer>

    <!-- è¨­å®šé‡‘é‘°å½ˆå‡ºè¦–çª— -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-800">è¨­å®š Gemini API é‡‘é‘°</h2>
            <p class="text-sm text-gray-600 mb-4">
                è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Keyã€‚æ‚¨çš„é‡‘é‘°å°‡åƒ…å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå‚³é€çµ¦é–‹ç™¼è€…ã€‚
                <br><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">å–å¾— API Key</a>
            </p>
            <input type="password" id="api-key-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" placeholder="è²¼ä¸Šæ‚¨çš„ API Key">
            <div class="flex justify-end gap-3">
                <button id="close-settings-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">å–æ¶ˆ</button>
                <button id="save-api-key-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç›¸æ©Ÿæƒæå½ˆå‡ºè¦–çª— -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                ç›¸æ©Ÿæƒæ
            </h2>
            <div class="relative flex justify-center items-center bg-black rounded-xl overflow-hidden shadow-inner aspect-[3/4] md:aspect-video">
                <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="photo-canvas"></canvas>
            </div>
            
            <div id="camera-message" class="text-center text-sm text-red-500 mt-2 hidden"></div>

            <div class="flex justify-between mt-6 space-x-3">
                <button id="close-modal-btn" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button id="capture-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition disabled:opacity-50">
                    æˆªåœ–ä¸¦ç¿»è­¯
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // -------------------------
        // 1. ç³»çµ±è®Šæ•¸èˆ‡é‡‘é‘°ç®¡ç†
        // -------------------------
        
        // ã€ä½¿ç”¨è€…å°ˆå€ã€‘å¦‚æœæ‚¨æƒ³å°‡é‡‘é‘°ç›´æ¥å¯«åœ¨æª”æ¡ˆè£¡ï¼Œè«‹å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­ï¼š
        const hardcodedApiKey = "AIzaSyCnGEmjLPIGXlY9GWKPRtAA524fG8b6T3w"; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, onSnapshot, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let auth, db, userId = null;
        let isAuthReady = false;
        let cameraStream = null;
        
        // å„ªå…ˆé †åºï¼šç¶²å€åƒæ•¸ > ç¨‹å¼ç¢¼å¯«æ­» > æœ¬åœ°å„²å­˜
        const urlParams = new URLSearchParams(window.location.search);
        const urlApiKey = urlParams.get('apikey');
        let localApiKey = localStorage.getItem('gemini_api_key') || "";
        
        // ç’°å¢ƒè®Šæ•¸ (Canvas å°ˆç”¨ï¼Œä¸€èˆ¬ç¶²é å¯å¿½ç•¥)
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const envInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const envCanvasApiKey = ""; // Canvas ç’°å¢ƒæä¾›çš„é‡‘é‘° (é€šå¸¸ç‚ºç©º)

        // æ±ºå®šæœ€çµ‚ä½¿ç”¨çš„ API Key
        let geminiApiKey = hardcodedApiKey || urlApiKey || localApiKey || envCanvasApiKey;

        // UI é‚è¼¯ï¼šå¦‚æœæœ‰é‡‘é‘°ï¼Œéš±è—è¨­å®šæŒ‰éˆ•ï¼›å¦‚æœæ˜¯ç¶²å€å¸¶ä¾†çš„ï¼Œå­˜èµ·ä¾†ä¸¦æ¸…ç¶²å€
        const settingsBtn = document.getElementById('settings-btn');
        if (geminiApiKey && geminiApiKey.length > 10) {
            settingsBtn.style.display = 'none'; // éš±è—æŒ‰éˆ•
            
            // å¦‚æœæ˜¯å¾ç¶²å€ä¾†çš„ï¼Œå­˜å…¥ localStorage ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            if (urlApiKey) {
                localStorage.setItem('gemini_api_key', urlApiKey);
                // æ¸…é™¤ç¶²å€åˆ—ä¸Šçš„é‡‘é‘°ï¼Œä¿è­·éš±ç§
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } else {
            // å¦‚æœæ²’æœ‰é‡‘é‘°ï¼Œé¡¯ç¤ºè¨­å®šæŒ‰éˆ•
            settingsBtn.style.display = 'flex';
        }

        // --- é‡‘é‘°è¨­å®šè¦–çª—é‚è¼¯ ---
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
            apiKeyInput.value = localApiKey;
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                geminiApiKey = key;
                settingsModal.classList.add('hidden');
                settingsModal.classList.remove('flex');
                settingsBtn.style.display = 'none'; // è¨­å®šæˆåŠŸå¾Œéš±è—æŒ‰éˆ•
                alert('é‡‘é‘°å·²å„²å­˜ï¼');
                location.reload(); // é‡æ–°æ•´ç†ä»¥å¥—ç”¨
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key');
            }
        });


        // -------------------------
        // 2. Firebase åˆå§‹åŒ–
        // -------------------------
        let localFirebaseConfigStr = localStorage.getItem('firebase_config_str') || "";
        let firebaseConfig = {};
        
        if (localFirebaseConfigStr) {
            try { firebaseConfig = JSON.parse(localFirebaseConfigStr); } catch (e) { console.error("Config Error", e); }
        } else {
            firebaseConfig = envFirebaseConfig;
        }

        const initFirebaseSystem = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("UserID:", userId);
                            isAuthReady = true;
                            loadTranslationHistory();
                        }
                    });

                    if (envInitialAuthToken && !localFirebaseConfigStr) {
                        await signInWithCustomToken(auth, envInitialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    document.getElementById('history-placeholder').textContent = "æ­·å²ç´€éŒ„æœå‹™ç„¡æ³•é€£ç·š";
                }
            } else {
                console.warn("No Firebase Config");
                document.getElementById('history-placeholder').textContent = "æœªè¨­å®šè³‡æ–™åº« (æ­·å²ç´€éŒ„åŠŸèƒ½åœç”¨)";
            }
        };

        initFirebaseSystem();


        // -------------------------
        // 3. èƒŒæ™¯æ›´æ›é‚è¼¯
        // -------------------------
        const bgUploadInput = document.getElementById('bg-upload');
        const changeBgBtn = document.getElementById('change-bg-btn');

        function loadSavedBackground() {
            const savedBg = localStorage.getItem('translatorAppBg');
            if (savedBg) {
                document.body.style.backgroundImage = `url(${savedBg})`;
            }
        }

        changeBgBtn.addEventListener('click', () => bgUploadInput.click());

        bgUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const bgUrl = event.target.result;
                    document.body.style.backgroundImage = `url(${bgUrl})`;
                    try { localStorage.setItem('translatorAppBg', bgUrl); } catch (err) {}
                };
                reader.readAsDataURL(file);
            }
        });


        // -------------------------
        // 4. ç¿»è­¯èˆ‡ä»‹é¢é‚è¼¯
        // -------------------------

        const sourceTextEl = document.getElementById('source-text');
        const targetTextEl = document.getElementById('target-text');
        const sourceLangEl = document.getElementById('source-lang');
        const targetLangEl = document.getElementById('target-lang');
        const swapBtn = document.getElementById('swap-btn');
        const scanBtn = document.getElementById('scan-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const copyBtn = document.getElementById('copy-btn');
        const speakBtn = document.getElementById('speak-btn');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const statusMessageEl = document.getElementById('status-message');
        const historyListEl = document.getElementById('history-list');
        const historyPlaceholderEl = document.getElementById('history-placeholder');
        
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const clearImageBtn = document.getElementById('clear-image-btn');
        let currentBase64Image = null;
        let isPdfMode = false;

        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cameraMessage = document.getElementById('camera-message');

        let debounceTimer;

        async function fetchWithExponentialBackoff(apiCall, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function saveTranslationToHistory(sourceText, targetText, sourceLang, targetLang) {
            if (!isAuthReady || !userId || !db) return;
            const currentAppId = envAppId || 'my-translator-app';
            try {
                await addDoc(collection(db, 'artifacts', currentAppId, 'users', userId, 'translationHistory'), {
                    sourceText: sourceText,
                    targetText: targetText,
                    sourceLang: sourceLang,
                    targetLang: targetLang,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("å„²å­˜å¤±æ•—:", error);
            }
        }

        async function translateText(base64Image = null) {
            if (!geminiApiKey) {
                targetTextEl.value = 'âš ï¸ æœªåµæ¸¬åˆ° API Keyã€‚è«‹é»æ“Šå³ä¸Šè§’ã€Œè¨­å®šé‡‘é‘°ã€æˆ–ä½¿ç”¨ç¶²å€å¸¶å…¥ Keyã€‚';
                return;
            }

            const inputText = sourceTextEl.value.trim();
            const sourceLang = sourceLangEl.value;
            const targetLang = targetLangEl.value;

            if (!inputText && !base64Image) return;

            statusMessageEl.classList.add('hidden');
            targetTextEl.value = 'âœ¨ AI æ­£åœ¨æ€è€ƒä¸¦ç¿»è­¯ä¸­...';

            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
            
            let systemPrompt = "You are a highly accurate and professional language translator. Your task is to provide a precise translation into the target language. Crucially, ensure that the translated text adheres to the strict grammatical rules, appropriate tense, and idiomatic correctness of the target language. Do not include any extra commentary, explanations, or formatting. Only return the translated text.";
            
            if (isPdfMode && !base64Image) {
                systemPrompt = "You are a bilingual document translator. Translate the given text into the target language. Crucially, output the result in a 'Bilingual Format': For each paragraph of the original text, display the ORIGINAL text first, followed immediately by its TRANSLATION. Separate the original and translation clearly (e.g., with a line break). Maintain the original paragraph structure.";
            }

            let textPrompt = "";
            if (sourceLang === 'auto') {
                textPrompt = `Translate the following text into ISO-639-1 code "${targetLang}". Automatically detect the source language. If input is an image, first perform OCR to extract the text, and then translate it. If input is text, translate directly. Return ONLY the translated text (or bilingual text if requested).`;
            } else {
                textPrompt = `Translate the following text from ISO-639-1 code "${sourceLang}" to ISO-639-1 code "${targetLang}". If input is an image, first perform OCR to extract the text, and then translate it. If input is text, translate directly. Return ONLY the translated text (or bilingual text if requested).`;
            }
            
            const contents = [];
            let sourceTextForHistory = inputText;

            if (base64Image) {
                sourceTextForHistory = `[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]`; 
                contents.push({
                    parts: [
                        { text: textPrompt },
                        { inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } }
                    ]
                });
            } else {
                contents.push({
                    parts: [
                        { text: `${textPrompt} The text to translate is: \n\n"${inputText}"` }
                    ]
                });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            
            let translatedText = null;

            try {
                const apiCall = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${JSON.stringify(errorBody)}`);
                    }
                    return response.json();
                };

                const result = await fetchWithExponentialBackoff(apiCall);
                translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (translatedText) {
                    targetTextEl.value = translatedText.trim();
                    saveTranslationToHistory(sourceTextForHistory, translatedText.trim(), sourceLang, targetLang);
                } else {
                    targetTextEl.value = 'ç¿»è­¯å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }

            } catch (error) {
                console.error("éŒ¯èª¤:", error);
                statusMessageEl.textContent = `éŒ¯èª¤: ${error.message}`;
                statusMessageEl.classList.remove('hidden');
                targetTextEl.value = 'é€£ç·šå¤±æ•—ã€‚è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚';
            }
        }

        // --- Copy & Speak Logic ---
        copyBtn.addEventListener('click', async () => {
            const textToCopy = targetTextEl.value; 
            if (!textToCopy || textToCopy.includes('è¼¸å…¥æ–‡å­—') || textToCopy.includes('AI æ­£åœ¨æ€è€ƒ')) return;
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    targetTextEl.select();
                    document.execCommand('copy');
                }
                const originalText = copyBtn.innerText;
                copyBtn.innerText = `âœ… å·²è¤‡è£½`;
                setTimeout(() => copyBtn.innerText = originalText, 2000);
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—', err);
            }
        });

        speakBtn.addEventListener('click', () => {
            const textToSpeak = targetTextEl.value; 
            if (!textToSpeak || textToSpeak.includes('è¼¸å…¥æ–‡å­—') || textToSpeak.includes('AI æ­£åœ¨æ€è€ƒ')) return;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            const targetLang = targetLangEl.value;
            utterance.lang = targetLang === 'zh-Hant' ? 'zh-TW' : targetLang;
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        });


        // --- PDF è™•ç† ---
        pdfBtn.addEventListener('click', () => pdfUploadInput.click());

        pdfUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') { alert('è«‹ä¸Šå‚³ PDF æª”æ¡ˆ'); return; }

            isPdfMode = true; 
            clearImagePreview();
            targetTextEl.value = 'ğŸ“„ æ­£åœ¨è§£æ PDF æ–‡ä»¶ï¼Œè«‹ç¨å€™...';
            sourceTextEl.value = 'æ­£åœ¨è®€å– PDF å…§å®¹...';
            sourceTextEl.disabled = true;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                if (!fullText.trim()) {
                    sourceTextEl.value = 'PDF è§£æå®Œæˆï¼Œä½†æœªç™¼ç¾å¯æå–çš„æ–‡å­—ã€‚\n\né€™å¯èƒ½æ˜¯ä¸€å€‹æƒæç‰ˆ PDF (åœ–ç‰‡æ ¼å¼)ã€‚è«‹ä½¿ç”¨ã€Œç›¸æ©Ÿã€åŠŸèƒ½ç¿»æ‹æˆ–å°‡é é¢æˆªåœ–è²¼ä¸Šä¾†é€²è¡Œç¿»è­¯ã€‚';
                    targetTextEl.value = 'ç„¡æ³•æå–æ–‡å­—ï¼Œå¯èƒ½æ˜¯åœ–ç‰‡å‹ PDFã€‚';
                } else {
                    sourceTextEl.value = fullText.trim();
                    translateText();
                }
            } catch (error) {
                console.error('PDF éŒ¯èª¤:', error);
                sourceTextEl.value = '';
                targetTextEl.value = 'PDF è§£æå¤±æ•—ã€‚';
            } finally {
                sourceTextEl.disabled = false;
                pdfUploadInput.value = '';
            }
        });

        // --- è‡ªå‹•ç¿»è­¯èˆ‡äº‹ä»¶ç›£è½ ---
        function debounceTranslate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (!currentBase64Image && sourceTextEl.value.trim()) {
                    translateText();
                }
            }, 1000); 
        }

        sourceTextEl.addEventListener('input', () => {
            if (currentBase64Image) clearImagePreview();
            
            if (sourceTextEl.value.trim() === '') {
                isPdfMode = false;
                targetTextEl.value = ''; // Clear result
                return;
            }
            debounceTranslate();
        });

        sourceTextEl.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        handleImageInput(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                    return;
                }
            }
        });

        function handleImageInput(base64) {
            currentBase64Image = base64;
            isPdfMode = false;
            imagePreview.src = base64;
            imagePreviewContainer.classList.remove('hidden');
            sourceTextEl.value = ''; 
            sourceTextEl.placeholder = "å·²åµæ¸¬åœ–ç‰‡æ¨¡å¼ï¼Œè¼¸å…¥æ–‡å­—å°‡åˆ‡æ›å›æ–‡å­—ç¿»è­¯...";
            translateText(base64);
        }

        function clearImagePreview() {
            currentBase64Image = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            sourceTextEl.placeholder = "è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–è²¼ä¸Šæˆªåœ–...";
        }
        
        clearImageBtn.addEventListener('click', () => {
            clearImagePreview();
            targetTextEl.value = '';
        });

        // --- æ­·å²ç´€éŒ„èˆ‡å…¶ä»– ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function renderHistory(snapshot) {
            historyListEl.innerHTML = '';
            if (snapshot.empty) {
                historyListEl.innerHTML = '<div class="text-center text-gray-500 py-6 bg-white/50 rounded-lg">å°šç„¡ç´€éŒ„</div>';
                return;
            }
            const historyRecords = [];
            snapshot.forEach(doc => historyRecords.push(doc.data()));
            historyRecords.sort((a, b) => {
                if (!a.timestamp || !b.timestamp) return 0;
                try { return b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime(); } 
                catch (e) { return 0; }
            });
            historyRecords.forEach(data => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item bg-white/70 p-4 rounded-xl border border-gray-100 hover:bg-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md flex-shrink-0';
                historyItem.addEventListener('click', () => {
                    if (data.sourceText !== '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]') {
                        sourceTextEl.value = data.sourceText;
                        clearImagePreview();
                        isPdfMode = false;
                        translateText(); 
                    } else {
                        sourceTextEl.value = '';
                        targetTextEl.value = data.targetText;
                    }
                    sourceLangEl.value = data.sourceLang;
                    targetLangEl.value = data.targetLang;
                    document.getElementById('translator-card').scrollIntoView({ behavior: 'smooth' });
                });
                
                const displaySourceText = data.sourceText === '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]' 
                    ? '<span class="flex items-center text-emerald-600">åœ–ç‰‡ç¿»è­¯çµæœ</span>' 
                    : data.sourceText;
                const getLangName = (code) => {
                    const map = { 'auto': 'è‡ªå‹•', 'en': 'è‹±', 'zh-Hant': 'ä¸­', 'ja': 'æ—¥', 'ko': 'éŸ“', 'es': 'è¥¿', 'fr': 'æ³•' };
                    return map[code] || code.toUpperCase();
                };
                historyItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${getLangName(data.sourceLang)} â†’ ${getLangName(data.targetLang)}</span>
                        <span class="text-xs text-gray-400">${formatTimestamp(data.timestamp)}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-800 line-clamp-2 mb-1 break-all">${displaySourceText}</p>
                    <p class="text-xs text-gray-600 mt-1 line-clamp-2 pl-2 border-l-2 border-blue-300 break-all">${data.targetText}</p>
                `;
                historyListEl.appendChild(historyItem);
            });
        }
        
        function loadTranslationHistory() {
            if (!db || !userId) return;
            const currentAppId = envAppId || 'my-translator-app';
            const historyQuery = query(
                collection(db, 'artifacts', currentAppId, 'users', userId, 'translationHistory'),
                limit(50) 
            );
            onSnapshot(historyQuery, (snapshot) => renderHistory(snapshot), (error) => {
                console.error("è¼‰å…¥å¤±æ•—:", error);
            });
        }

        scanBtn.addEventListener('click', initCamera);
        captureBtn.addEventListener('click', captureImage);
        closeModalBtn.addEventListener('click', () => {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
        });
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) closeModalBtn.click();
        });

        swapBtn.addEventListener('click', () => {
            const tempSource = sourceLangEl.value;
            if (tempSource === 'auto') {
                sourceLangEl.value = targetLangEl.value;
                targetLangEl.value = 'zh-Hant'; 
            } else {
                sourceLangEl.value = targetLangEl.value;
                targetLangEl.value = tempSource;
            }
            if (sourceTextEl.value.trim()) translateText();
        });

        async function initCamera() {
            cameraMessage.classList.add('hidden');
            cameraModal.classList.add('flex');
            cameraModal.classList.remove('hidden');
            captureBtn.disabled = true;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
            } catch (err) {
                try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: true }); } 
                catch (err) { cameraMessage.textContent = 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ'; cameraMessage.classList.remove('hidden'); return; }
            }
            cameraFeed.srcObject = cameraStream;
            cameraFeed.onloadedmetadata = () => { cameraFeed.play(); captureBtn.disabled = false; };
        }

        function captureImage() {
            if (!cameraStream) return;
            const video = cameraFeed;
            const canvas = photoCanvas;
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL('image/png');
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
            handleImageInput(base64Image);
        }

        window.onload = () => {
            loadSavedBackground();
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¹³å°ç¿»è­¯ App</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ PDF.js ç”¨æ–¼è§£æ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* é è¨­æ·ºç°èƒŒæ™¯ */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
            pointer-events: none;
        }

        /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.85); /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* è‡ªå®šç¾©æ²å‹•æ¢ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        
        /* æ¡Œé¢ç‰ˆæ¨£å¼å¾®èª¿ */
        @media (min-width: 1024px) {
            #main-content {
                align-items: stretch; /* å¼·åˆ¶å·¦å³ç­‰é«˜ */
            }
            .grid-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            #source-text, #target-text {
                min-height: 120px; /* è¨­å®šä¸€å€‹è¼ƒå°çš„æœ€å°é«˜åº¦ */
            }
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <!-- é ‚éƒ¨åŠŸèƒ½åˆ— -->
    <header class="w-full max-w-6xl flex justify-end items-center mb-2 mt-2 px-2 flex-shrink-0">
        <div class="flex gap-3">
            <!-- é€™è£¡ç§»é™¤äº†è¨­å®šæŒ‰éˆ•ï¼Œå› ç‚ºé‡‘é‘°å·²å…§å»º -->
            <input type="file" id="bg-upload" accept="image/*" class="hidden">
            <button id="change-bg-btn" class="flex items-center px-4 py-2 bg-white/80 hover:bg-white text-gray-700 font-medium rounded-full shadow-sm transition duration-200 backdrop-blur-sm border border-gray-200 text-sm">
                æ›´æ›èƒŒæ™¯
            </button>
        </div>
    </header>

    <!-- ä¸»ä»‹é¢ -->
    <main id="main-content" class="w-full max-w-6xl flex flex-col lg:flex-row gap-6 mt-2 lg:items-stretch">

        <!-- å·¦å´ï¼šç¿»è­¯å€ -->
        <div id="translator-card" class="lg:w-2/3 glass-panel rounded-3xl shadow-xl p-6 transition-all duration-300 flex flex-col h-full">
            
            <!-- èªè¨€é¸æ“‡ -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-3 sm:space-y-0 sm:space-x-4 flex-shrink-0">
                <div class="flex-1 w-full sm:w-auto relative group">
                    <select id="source-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm cursor-pointer text-base">
                        <option value="auto" selected>âœ¨ è‡ªå‹•åµæ¸¬èªè¨€</option>
                        <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                        <option value="en">è‹±æ–‡</option>
                        <option value="ja">æ—¥æ–‡</option>
                        <option value="ko">éŸ“æ–‡</option>
                        <option value="es">è¥¿ç­ç‰™æ–‡</option>
                        <option value="fr">æ³•æ–‡</option>
                        <option value="de">å¾·æ–‡</option>
                        <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                        <option value="vi">è¶Šå—æ–‡</option>
                        <option value="th">æ³°æ–‡</option>
                        <option value="id">å°å°¼æ–‡</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <button id="swap-btn" class="p-3 bg-white/80 rounded-full hover:bg-blue-50 text-blue-600 transition duration-150 ease-in-out shadow-sm border border-gray-100 sm:mt-6 group backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m2.25-4.5L21 7.5m0 0L16.5 3M21 7.5H7.5" />
                    </svg>
                </button>
                
                <div class="flex-1 w-full sm:w-auto relative group">
                    <select id="target-lang" class="w-full p-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 font-medium transition duration-150 ease-in-out appearance-none backdrop-blur-sm text-base">
                        <option value="en" selected>è‹±æ–‡</option>
                        <option value="zh-Hant">ä¸­æ–‡ (ç¹é«”)</option>
                        <option value="ja">æ—¥æ–‡</option>
                        <option value="ko">éŸ“æ–‡</option>
                        <option value="es">è¥¿ç­ç‰™æ–‡</option>
                        <option value="fr">æ³•æ–‡</option>
                        <option value="de">å¾·æ–‡</option>
                        <option value="it">ç¾©å¤§åˆ©æ–‡</option>
                        <option value="vi">è¶Šå—æ–‡</option>
                        <option value="th">æ³°æ–‡</option>
                        <option value="id">å°å°¼æ–‡</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            
            <!-- è¼¸å…¥èˆ‡è¼¸å‡ºå€ -->
            <div class="grid-container flex-grow">
                
                <!-- å·¦æ¬„ï¼šè¼¸å…¥å€ -->
                <div class="input-group flex flex-col gap-3 h-full">
                    <!-- åœ–ç‰‡é è¦½å€ -->
                    <div id="image-preview-container" class="hidden relative bg-gray-100/80 rounded-xl overflow-hidden border border-dashed border-gray-400 backdrop-blur-sm flex-shrink-0 h-32">
                        <img id="image-preview" src="" alt="é è¦½" class="w-full h-full object-contain bg-transparent">
                        <button id="clear-image-btn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="textarea-container flex-grow flex flex-col">
                        <textarea id="source-text" rows="3"
                            class="w-full flex-grow p-4 bg-white/60 border border-gray-200 rounded-2xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none text-gray-800 placeholder-gray-500 backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed text-lg" 
                            placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–è²¼ä¸Šæˆªåœ–..."></textarea>
                    </div>
                    
                    <!-- æŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="flex gap-3 flex-shrink-0">
                        <button id="scan-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-emerald-500/90 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" />
                            </svg>
                            ç›¸æ©Ÿ
                        </button>
                        
                        <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
                        <button id="pdf-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-red-500/90 hover:bg-red-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25M15 12h3M7.5 16.5h4.5M7.5 12h7.5M8.25 3.75H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            ä¸Šå‚³ PDF
                        </button>
                    </div>
                </div>
                
                <!-- å³æ¬„ï¼šçµæœå€ -->
                <div class="output-group flex flex-col gap-3 mt-6 lg:mt-0 h-full">
                    <div class="textarea-container flex-grow flex flex-col">
                        <textarea id="target-text" rows="3"
                            class="w-full flex-grow p-4 bg-blue-50/60 border border-blue-100 rounded-2xl text-gray-800 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150 ease-in-out resize-none backdrop-blur-sm overflow-y-auto custom-scrollbar leading-relaxed text-lg" 
                            readonly
                            placeholder="ç¿»è­¯çµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                    </div>

                    <!-- æŒ‰éˆ•ç¾¤çµ„ -->
                    <div class="flex gap-3 flex-shrink-0">
                        <button id="copy-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-500/90 hover:bg-blue-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                            è¤‡è£½
                        </button>
                        
                        <button id="speak-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-indigo-500/90 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-md transition duration-200 ease-in-out transform active:scale-[0.98] text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                            </svg>
                            æœ—è®€
                        </button>
                    </div>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯å’Œ API ç‹€æ…‹ -->
            <div id="status-message" class="mt-4 text-center text-red-500 font-medium hidden bg-red-50/80 p-2 rounded-lg flex-shrink-0"></div>
        </div>

        <!-- å³å´ï¼šæ­·å²ç´€éŒ„å´é‚Šæ¬„ -->
        <div id="history-sidebar" class="lg:w-1/3 glass-panel rounded-3xl shadow-xl p-6 transition-all duration-300 flex flex-col h-full lg:max-h-none">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200/50 pb-3 flex items-center flex-shrink-0"> 
                ç¿»è­¯æ­·å²ç´€éŒ„
            </h2>
            <div id="history-list" class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-grow"> 
                <div id="history-placeholder" class="text-gray-500 text-sm py-4 text-center">
                    <p>å°šç„¡ç´€éŒ„...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 mb-4 flex flex-col items-center">
        <p class="text-gray-500 text-sm bg-white/40 px-3 py-1 rounded-md backdrop-blur-sm">
            ç¿»è­¯ç”± Gemini 2.5 Flash æä¾›æ”¯æ´
        </p>
    </footer>

    <!-- ç›¸æ©Ÿæƒæå½ˆå‡ºè¦–çª— -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                ç›¸æ©Ÿæƒæ
            </h2>
            <div class="relative flex justify-center items-center bg-black rounded-xl overflow-hidden shadow-inner aspect-[3/4] md:aspect-video">
                <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="photo-canvas"></canvas>
            </div>
            
            <div id="camera-message" class="text-center text-sm text-red-500 mt-2 hidden"></div>

            <div class="flex justify-between mt-6 space-x-3">
                <button id="close-modal-btn" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button id="capture-btn" class="flex-1 flex items-center justify-center px-4 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition disabled:opacity-50">
                    æˆªåœ–ä¸¦ç¿»è­¯
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // -------------------------
        // 1. é‡‘é‘°è¨­å®š
        // -------------------------
        const geminiApiKey = "AIzaSyDJoBgo2MLzJkTG2WI593SmWxQuNxcjJ5U"; 

        // -------------------------
        // 2. DOM èˆ‡è®Šæ•¸
        // -------------------------
        const sourceTextEl = document.getElementById('source-text');
        const targetTextEl = document.getElementById('target-text');
        const sourceLangEl = document.getElementById('source-lang');
        const targetLangEl = document.getElementById('target-lang');
        const swapBtn = document.getElementById('swap-btn');
        const scanBtn = document.getElementById('scan-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const copyBtn = document.getElementById('copy-btn');
        const speakBtn = document.getElementById('speak-btn');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const statusMessageEl = document.getElementById('status-message');
        const historyListEl = document.getElementById('history-list');
        const historyPlaceholderEl = document.getElementById('history-placeholder');
        
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const clearImageBtn = document.getElementById('clear-image-btn');
        let currentBase64Image = null;
        let isPdfMode = false;

        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cameraMessage = document.getElementById('camera-message');
        let cameraStream = null;
        let debounceTimer;

        // -------------------------
        // 3. èƒŒæ™¯æ›´æ› (LocalStorage)
        // -------------------------
        const bgUploadInput = document.getElementById('bg-upload');
        const changeBgBtn = document.getElementById('change-bg-btn');

        function loadSavedBackground() {
            const savedBg = localStorage.getItem('translatorAppBg');
            if (savedBg) {
                document.body.style.backgroundImage = `url(${savedBg})`;
            }
        }

        changeBgBtn.addEventListener('click', () => bgUploadInput.click());

        bgUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const bgUrl = event.target.result;
                    document.body.style.backgroundImage = `url(${bgUrl})`;
                    try { localStorage.setItem('translatorAppBg', bgUrl); } catch (err) {}
                };
                reader.readAsDataURL(file);
            }
        });

        // -------------------------
        // 4. ç¿»è­¯é‚è¼¯ (Fetch API)
        // -------------------------
        async function fetchWithExponentialBackoff(apiCall, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function translateText(base64Image = null) {
            const inputText = sourceTextEl.value.trim();
            const sourceLang = sourceLangEl.value;
            const targetLang = targetLangEl.value;

            if (!inputText && !base64Image) return;

            statusMessageEl.classList.add('hidden');
            targetTextEl.value = 'âœ¨ AI æ­£åœ¨æ€è€ƒä¸¦ç¿»è­¯ä¸­...';

            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
            
            let systemPrompt = "You are a professional translator. Translate accurately.";
            if (isPdfMode && !base64Image) {
                systemPrompt = "You are a bilingual document translator. Output in 'Bilingual Format': Original text first, then Translation.";
            }

            let textPrompt = "";
            if (sourceLang === 'auto') {
                textPrompt = `Translate to ISO-639-1 code "${targetLang}". Detect source language. Return ONLY the translated text.`;
            } else {
                textPrompt = `Translate from ISO-639-1 code "${sourceLang}" to "${targetLang}". Return ONLY the translated text.`;
            }
            
            const contents = [];
            let sourceTextForHistory = inputText;

            if (base64Image) {
                sourceTextForHistory = `[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]`; 
                contents.push({
                    parts: [
                        { text: textPrompt },
                        { inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } }
                    ]
                });
            } else {
                contents.push({
                    parts: [
                        { text: `${textPrompt}\n\n"${inputText}"` }
                    ]
                });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            
            let translatedText = null;

            try {
                const apiCall = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
                    }
                    return response.json();
                };

                const result = await fetchWithExponentialBackoff(apiCall);
                translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (translatedText) {
                    targetTextEl.value = translatedText.trim();
                    saveHistory(sourceTextForHistory, translatedText.trim(), sourceLang, targetLang);
                } else {
                    targetTextEl.value = 'ç¿»è­¯å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }

            } catch (error) {
                console.error("éŒ¯èª¤:", error);
                statusMessageEl.textContent = `éŒ¯èª¤: ${error.message}`;
                statusMessageEl.classList.remove('hidden');
                targetTextEl.value = 'é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚';
            }
        }

        // -------------------------
        // 5. æ­·å²ç´€éŒ„ (Local Storage)
        // -------------------------
        function saveHistory(src, tgt, sLang, tLang) {
            const newRecord = {
                sourceText: src,
                targetText: tgt,
                sourceLang: sLang,
                targetLang: tLang,
                timestamp: new Date().getTime()
            };
            
            let history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            history.unshift(newRecord); // Add to top
            if (history.length > 50) history = history.slice(0, 50); // Keep last 50
            
            localStorage.setItem('translationHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            historyListEl.innerHTML = '';
            
            if (history.length === 0) {
                historyListEl.innerHTML = '<div class="text-center text-gray-500 py-6">å°šç„¡ç´€éŒ„</div>';
                return;
            }

            history.forEach(data => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white/70 p-4 rounded-xl border border-gray-100 hover:bg-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md flex-shrink-0 mb-3';
                
                historyItem.addEventListener('click', () => {
                    if (data.sourceText !== '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]') {
                        sourceTextEl.value = data.sourceText;
                        translateText(); 
                    } else {
                        sourceTextEl.value = '';
                        targetTextEl.value = data.targetText;
                    }
                    sourceLangEl.value = data.sourceLang;
                    targetLangEl.value = data.targetLang;
                });
                
                const timeStr = new Date(data.timestamp).toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false });
                const displaySourceText = data.sourceText === '[å¾åœ–ç‰‡æƒæä¸¦ç¿»è­¯]' 
                    ? '<span class="text-emerald-600 font-bold">åœ–ç‰‡ç¿»è­¯</span>' 
                    : data.sourceText;

                const getLangName = (code) => {
                    const map = { 'auto': 'è‡ªå‹•', 'en': 'è‹±', 'zh-Hant': 'ä¸­', 'ja': 'æ—¥', 'ko': 'éŸ“', 'es': 'è¥¿', 'fr': 'æ³•' };
                    return map[code] || code.toUpperCase();
                };

                historyItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${getLangName(data.sourceLang)} â†’ ${getLangName(data.targetLang)}</span>
                        <span class="text-xs text-gray-400">${timeStr}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-800 line-clamp-1 mb-1 break-all">${displaySourceText}</p>
                    <p class="text-xs text-gray-500 line-clamp-1 break-all">${data.targetText}</p>
                `;
                historyListEl.appendChild(historyItem);
            });
        }

        // -------------------------
        // 6. å…¶ä»–åŠŸèƒ½ (è¤‡è£½ã€æœ—è®€ã€ç›¸æ©Ÿã€PDF)
        // -------------------------
        copyBtn.addEventListener('click', async () => {
            const textToCopy = targetTextEl.value; 
            if (!textToCopy) return;
            try {
                await navigator.clipboard.writeText(textToCopy);
                const originalText = copyBtn.innerText;
                copyBtn.innerText = `âœ… å·²è¤‡è£½`;
                setTimeout(() => copyBtn.innerText = originalText, 2000);
            } catch (err) {}
        });

        speakBtn.addEventListener('click', () => {
            const textToSpeak = targetTextEl.value; 
            if (!textToSpeak) return;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = targetLangEl.value === 'zh-Hant' ? 'zh-TW' : targetLangEl.value;
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        });

        pdfBtn.addEventListener('click', () => pdfUploadInput.click());
        pdfUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            isPdfMode = true; 
            clearImagePreview();
            targetTextEl.value = 'ğŸ“„ è§£æ PDF ä¸­...';
            sourceTextEl.value = 'è®€å–ä¸­...';
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }
                sourceTextEl.value = fullText.trim() || "PDF ç„¡æ³•è®€å– (å¯èƒ½æ˜¯åœ–ç‰‡)";
                translateText();
            } catch (error) { sourceTextEl.value = "PDF è®€å–å¤±æ•—"; }
            pdfUploadInput.value = '';
        });

        function debounceTranslate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (!currentBase64Image && sourceTextEl.value.trim()) translateText();
            }, 300); 
        }

        sourceTextEl.addEventListener('input', () => {
            if (currentBase64Image) clearImagePreview();
            if (sourceTextEl.value.trim() === '') {
                isPdfMode = false;
                targetTextEl.value = ''; 
                return;
            }
            debounceTranslate();
        });

        sourceTextEl.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => handleImageInput(event.target.result);
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                    return;
                }
            }
        });

        function handleImageInput(base64) {
            currentBase64Image = base64;
            isPdfMode = false;
            imagePreview.src = base64;
            imagePreviewContainer.classList.remove('hidden');
            sourceTextEl.value = ''; 
            sourceTextEl.placeholder = "å·²æ•æ‰åœ–ç‰‡...";
            translateText(base64);
        }

        function clearImagePreview() {
            currentBase64Image = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            sourceTextEl.placeholder = "è«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—ï¼Œæˆ–è²¼ä¸Šæˆªåœ–...";
        }
        clearImageBtn.addEventListener('click', () => { clearImagePreview(); targetTextEl.value = ''; });

        scanBtn.addEventListener('click', initCamera);
        captureBtn.addEventListener('click', captureImage);
        closeModalBtn.addEventListener('click', () => {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden'); cameraModal.classList.remove('flex');
        });

        swapBtn.addEventListener('click', () => {
            const tempSource = sourceLangEl.value;
            sourceLangEl.value = tempSource === 'auto' ? targetLangEl.value : targetLangEl.value;
            targetLangEl.value = tempSource === 'auto' ? 'zh-Hant' : tempSource;
            if (sourceTextEl.value.trim()) translateText();
        });

        async function initCamera() {
            cameraMessage.classList.add('hidden');
            cameraModal.classList.add('flex'); cameraModal.classList.remove('hidden');
            captureBtn.disabled = true;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
            } catch (err) {
                try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: true }); } 
                catch (err) { cameraMessage.textContent = 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ'; cameraMessage.classList.remove('hidden'); return; }
            }
            cameraFeed.srcObject = cameraStream;
            cameraFeed.onloadedmetadata = () => { cameraFeed.play(); captureBtn.disabled = false; };
        }

        function captureImage() {
            if (!cameraStream) return;
            const video = cameraFeed;
            const canvas = photoCanvas;
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL('image/png');
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden'); cameraModal.classList.remove('flex');
            handleImageInput(base64Image);
        }

        window.onload = () => {
            loadSavedBackground();
            loadHistory();
        }

    </script>
</body>
</html>